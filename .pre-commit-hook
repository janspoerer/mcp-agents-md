#!/bin/bash
# Pre-commit hook for MCP Agent Memory Server
# This hook runs tests and linting before allowing commits

set -e

echo "=== Running Pre-commit Checks ==="
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any check fails
FAILED=0

# Get the directory where the hook is installed
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

# Check if virtual environment exists
if [ ! -d "venv" ]; then
    echo -e "${YELLOW}Warning: Virtual environment not found. Skipping Python checks.${NC}"
    echo "Run ./setup.sh to create the virtual environment."
    exit 0
fi

# Activate virtual environment
source venv/bin/activate

# =============================================================================
# 1. Check for sensitive files being committed
# =============================================================================
echo "1. Checking for sensitive files..."

SENSITIVE_FILES=".env service_account.json *.pem *.key"
STAGED_FILES=$(git diff --cached --name-only)

for pattern in $SENSITIVE_FILES; do
    for file in $STAGED_FILES; do
        if [[ "$file" == $pattern ]]; then
            echo -e "${RED}ERROR: Attempting to commit sensitive file: $file${NC}"
            echo "Remove it from staging with: git reset HEAD $file"
            FAILED=1
        fi
    done
done

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}   No sensitive files detected${NC}"
fi

# =============================================================================
# 2. Run Python syntax check on staged Python files
# =============================================================================
echo ""
echo "2. Checking Python syntax..."

PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -n "$PYTHON_FILES" ]; then
    for file in $PYTHON_FILES; do
        if [ -f "$file" ]; then
            python -m py_compile "$file" 2>/dev/null
            if [ $? -ne 0 ]; then
                echo -e "${RED}ERROR: Syntax error in $file${NC}"
                python -m py_compile "$file"
                FAILED=1
            fi
        fi
    done

    if [ $FAILED -eq 0 ]; then
        echo -e "${GREEN}   All Python files have valid syntax${NC}"
    fi
else
    echo "   No Python files staged"
fi

# =============================================================================
# 3. Run ruff linter (if available)
# =============================================================================
echo ""
echo "3. Running linter..."

if command -v ruff &> /dev/null; then
    if [ -n "$PYTHON_FILES" ]; then
        # Only lint staged files
        ruff check $PYTHON_FILES --fix --exit-non-zero-on-fix 2>/dev/null
        if [ $? -ne 0 ]; then
            echo -e "${YELLOW}Warning: Linting issues found (auto-fixed where possible)${NC}"
            echo "Review changes and re-stage if needed"
            # Don't fail on lint warnings, just notify
        else
            echo -e "${GREEN}   Linting passed${NC}"
        fi
    fi
elif command -v flake8 &> /dev/null; then
    if [ -n "$PYTHON_FILES" ]; then
        flake8 $PYTHON_FILES --max-line-length=100 --ignore=E501,W503
        if [ $? -ne 0 ]; then
            echo -e "${YELLOW}Warning: Linting issues found${NC}"
        else
            echo -e "${GREEN}   Linting passed${NC}"
        fi
    fi
else
    echo "   Skipped (no linter installed)"
fi

# =============================================================================
# 4. Run type checking (if mypy available)
# =============================================================================
echo ""
echo "4. Running type check..."

if command -v mypy &> /dev/null; then
    if [ -n "$PYTHON_FILES" ]; then
        mypy $PYTHON_FILES --ignore-missing-imports --no-error-summary 2>/dev/null
        if [ $? -ne 0 ]; then
            echo -e "${YELLOW}Warning: Type checking issues found${NC}"
            # Don't fail on type errors, just notify
        else
            echo -e "${GREEN}   Type check passed${NC}"
        fi
    fi
else
    echo "   Skipped (mypy not installed)"
fi

# =============================================================================
# 5. Run tests
# =============================================================================
echo ""
echo "5. Running tests..."

if [ -d "tests" ]; then
    # Check if pytest is available
    if python -c "import pytest" 2>/dev/null; then
        # Run tests with minimal output
        python -m pytest tests/ -v --tb=short -q 2>&1
        if [ $? -ne 0 ]; then
            echo -e "${RED}ERROR: Tests failed${NC}"
            FAILED=1
        else
            echo -e "${GREEN}   All tests passed${NC}"
        fi
    else
        echo "   Skipped (pytest not installed)"
    fi
else
    echo "   Skipped (no tests directory)"
fi

# =============================================================================
# 6. Check for large files
# =============================================================================
echo ""
echo "6. Checking for large files..."

MAX_SIZE=1048576  # 1MB in bytes
LARGE_FILES=""

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        SIZE=$(wc -c < "$file" 2>/dev/null || echo 0)
        if [ "$SIZE" -gt "$MAX_SIZE" ]; then
            LARGE_FILES="$LARGE_FILES $file"
        fi
    fi
done

if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}Warning: Large files detected (>1MB):$LARGE_FILES${NC}"
    echo "Consider adding them to .gitignore"
else
    echo -e "${GREEN}   No large files detected${NC}"
fi

# =============================================================================
# Final result
# =============================================================================
echo ""
echo "==================================="

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}All pre-commit checks passed!${NC}"
    exit 0
else
    echo -e "${RED}Pre-commit checks failed. Please fix the errors above.${NC}"
    echo "To bypass this hook (not recommended): git commit --no-verify"
    exit 1
fi
